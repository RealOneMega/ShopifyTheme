<section class="header {% if section.settings.sticky %}header--sticky{% endif %}">
  {% if section.settings.show_utility_row %}
    {% assign utility_alignment = section.settings.utility_alignment | default: 'center' %}
    <div class="header__utility">
      <div class="header__utility-bar header__utility-bar--{{ utility_alignment }}">
        <div class="header__utility-slot header__utility-slot--left">
          {% if section.settings.utility_menu != blank and utility_alignment == 'left' %}
            <nav aria-label="Utility" class="header__utility-links">
              {% for link in linklists[section.settings.utility_menu].links %}
                <a href="{{ link.url }}">{{ link.title }}</a>
              {% endfor %}
            </nav>
          {% endif %}
        </div>
        <div class="header__utility-slot header__utility-slot--center">
          {% if section.settings.utility_menu != blank and utility_alignment == 'center' %}
            <nav aria-label="Utility" class="header__utility-links">
              {% for link in linklists[section.settings.utility_menu].links %}
                <a href="{{ link.url }}">{{ link.title }}</a>
              {% endfor %}
            </nav>
          {% endif %}
        </div>
        <div class="header__utility-slot header__utility-slot--right">
          {% if section.settings.utility_menu != blank and utility_alignment == 'right' %}
            <nav aria-label="Utility" class="header__utility-links">
              {% for link in linklists[section.settings.utility_menu].links %}
                <a href="{{ link.url }}">{{ link.title }}</a>
              {% endfor %}
            </nav>
          {% endif %}
          {% if section.settings.show_localization %}
            {% form 'localization' %}
              <select class="field field--select" name="country_code" aria-label="{{ 'localization.country_label' | t }}">
                {% for country in localization.available_countries %}
                  <option value="{{ country.iso_code }}" {% if country.iso_code == localization.country.iso_code %}selected{% endif %}>
                    {{ country.name }} ({{ country.currency.iso_code }})
                  </option>
                {% endfor %}
              </select>
            {% endform %}
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

  {% assign nav_class = 'nav' %}
  {% if section.settings.layout == 'logo_center' %}
    {% assign nav_class = 'nav nav--center' %}
  {% endif %}
  {% capture nav_markup %}
    <nav class="{{ nav_class }}" aria-label="Primary">
      {% for link in linklists[section.settings.main_menu].links %}
        <div class="nav__item">
          {% if link.links != blank %}
            <a class="nav__link" href="{{ link.url }}" data-mega-trigger aria-haspopup="true" aria-expanded="false">{{ link.title }}</a>
            <div class="nav__dropdown" aria-hidden="true">
              {% for child in link.links %}
                <div>
                  <strong>{{ child.title }}</strong>
                  <div class="stack" style="margin-top:0.5rem;">
                    {% for grandchild in child.links %}
                      <a href="{{ grandchild.url }}">{{ grandchild.title }}</a>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
              {% for block in section.blocks %}
                {% if block.type == 'promo' and block.settings.parent_link == link.title %}
                  <a href="{{ block.settings.link }}" style="display:block;">
                    {{ block.settings.image | image_url: width: 320 | image_tag: loading: 'lazy' }}
                    <p>{{ block.settings.heading }}</p>
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
          <a class="nav__link" href="{{ link.url }}">{{ link.title }}</a>
          {% endif %}
        </div>
      {% endfor %}
    </nav>
  {% endcapture %}

  <div class="header__main {% if section.settings.layout == 'logo_center' %}header__main--center{% endif %}">
    <button class="header__icon-button header__menu-toggle" type="button" data-drawer-open="#mobile-menu" aria-label="Open menu">
      {% render 'icon-menu' %}
    </button>

    {% assign logo_alignment = 'start' %}
    {% if section.settings.layout == 'logo_center' %}
      {% assign logo_alignment = 'center' %}
    {% endif %}
    <div class="header__logo" style="justify-self:{{ logo_alignment }};max-width:{{ section.settings.logo_width }}px;">
      <a href="{{ routes.root_url }}" aria-label="{{ shop.name }}">
        {% if settings.logo != blank %}
          {{ settings.logo | image_url: width: 320 | image_tag: loading: 'lazy', alt: shop.name, class: 'header__logo-image' }}
        {% else %}
          <strong>{{ shop.name }}</strong>
        {% endif %}
      </a>
    </div>

    {% if section.settings.layout == 'logo_left' %}
      {% assign menu_alignment = 'center' %}
      {% if section.settings.menu_position == 'right' %}
        {% assign menu_alignment = 'end' %}
      {% endif %}
      <div style="justify-self:{{ menu_alignment }};">
        {{ nav_markup }}
      </div>
    {% endif %}

    <div class="header__icons" style="justify-self:end;">
      <button class="header__icon-button" type="button" data-drawer-open="#search-drawer" aria-label="Search">
        {% render 'icon-search' %}
      </button>
      <a class="header__icon-button" href="{{ routes.account_url }}" aria-label="Account">
        {% render 'icon-account' %}
      </a>
      <button class="header__icon-button" type="button" data-wishlist-toggle="global" aria-label="Wishlist">
        {% render 'icon-heart' %}
      </button>
      <button class="header__icon-button" type="button" data-drawer-open="#cart-drawer" aria-label="Cart">
        {% render 'icon-cart' %}
        {% if cart.item_count > 0 %}
          <span class="header__badge" aria-live="polite">{{ cart.item_count }}</span>
        {% endif %}
      </button>
    </div>
  </div>

  {% if section.settings.layout == 'logo_center' %}
    {{ nav_markup }}
  {% endif %}
</section>

<div id="mobile-menu" class="drawer" role="dialog" aria-modal="true" aria-label="Mobile menu">
  <div class="drawer__header">
    <strong>Menu</strong>
    <button class="header__icon-button" type="button" data-drawer-close aria-label="Close menu">{% render 'icon-close' %}</button>
  </div>
  <div class="drawer__content">
    <nav aria-label="Mobile">
      {% for link in linklists[section.settings.main_menu].links %}
        <div class="stack" style="margin-bottom:1rem;">
          <a href="{{ link.url }}"><strong>{{ link.title }}</strong></a>
          {% if link.links != blank %}
            <div class="stack" style="margin-left:1rem;">
              {% for child in link.links %}
                <a href="{{ child.url }}">{{ child.title }}</a>
                {% if child.links != blank %}
                  <div class="stack" style="margin-left:1rem;">
                    {% for grandchild in child.links %}
                      <a href="{{ grandchild.url }}">{{ grandchild.title }}</a>
                    {% endfor %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </nav>
  </div>
</div>

<div id="search-drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Search">
  <div class="drawer__header">
    <strong>Search</strong>
    <button class="header__icon-button" type="button" data-drawer-close aria-label="Close search">{% render 'icon-close' %}</button>
  </div>
  <div class="drawer__content">
    <form action="{{ routes.search_url }}" method="get" role="search" data-predictive-search>
      <label class="visually-hidden" for="SearchInput">Search</label>
      <input id="SearchInput" type="search" name="q" placeholder="Search products" autocomplete="off">
      <div data-predictive-results></div>
    </form>
  </div>
</div>

<div id="cart-drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Cart">
  <div class="drawer__header">
    <strong>Cart</strong>
    <button class="header__icon-button" type="button" data-drawer-close aria-label="Close cart">{% render 'icon-close' %}</button>
  </div>
  <div class="drawer__content">
    {% if cart.item_count == 0 %}
      <p>Your cart is empty.</p>
      <a class="button button--primary" href="{{ routes.all_products_collection_url }}">Shop now</a>
    {% else %}
      <div class="stack">
        {% for item in cart.items %}
          <div style="display:grid;grid-template-columns:60px 1fr auto;gap:0.75rem;align-items:center;">
            {{ item.image | image_url: width: 120 | image_tag: loading: 'lazy' }}
            <div>
              <strong>{{ item.product.title }}</strong>
              <div>{{ item.final_price | money }}</div>
            </div>
            <span>{{ item.quantity }}</span>
          </div>
        {% endfor %}
      </div>
      <div style="margin-top:1.5rem;display:grid;gap:0.75rem;">
        <strong>Total: {{ cart.total_price | money }}</strong>
        <a class="button button--secondary" href="{{ routes.cart_url }}">View cart</a>
        <form action="{{ routes.cart_url }}" method="post">
          <button class="button button--primary" type="submit" name="checkout">Checkout</button>
        </form>
      </div>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "logo_left",
      "options": [
        {"value": "logo_left", "label": "Logo left"},
        {"value": "logo_center", "label": "Logo center"}
      ]
    },
    {
      "type": "select",
      "id": "menu_position",
      "label": "Menu position (logo left)",
      "default": "center",
      "options": [
        {"value": "center", "label": "Center"},
        {"value": "right", "label": "Right"}
      ]
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main menu"
    },
    {
      "type": "checkbox",
      "id": "sticky",
      "label": "Enable sticky header",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_utility_row",
      "label": "Show utility row",
      "default": false
    },
    {
      "type": "range",
      "id": "logo_width",
      "label": "Logo width",
      "min": 80,
      "max": 280,
      "step": 10,
      "default": 180,
      "unit": "px"
    },
    {
      "type": "link_list",
      "id": "utility_menu",
      "label": "Utility menu"
    },
    {
      "type": "select",
      "id": "utility_alignment",
      "label": "Utility menu alignment",
      "default": "center",
      "options": [
        {"value": "left", "label": "Left"},
        {"value": "center", "label": "Center"},
        {"value": "right", "label": "Right (next to selector)"}
      ]
    },
    {
      "type": "checkbox",
      "id": "show_localization",
      "label": "Show country selector",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "promo",
      "name": "Mega menu promo",
      "settings": [
        {
          "type": "text",
          "id": "parent_link",
          "label": "Parent link title"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Promo image"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ]
}
{% endschema %}
